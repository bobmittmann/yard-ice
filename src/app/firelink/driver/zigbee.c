/* 
 * File:	 usb-test.c
 * Author:   Robinson Mittmann (bobmittmann@gmail.com)
 * Target:
 * Comment:
 * Copyright(C) 2011 Bob Mittmann. All Rights Reserved.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */

#include <sys/stm32f.h>
#include <sys/serial.h>
#include <thinkos.h>
#include <stdlib.h>
#include <stdio.h>

#include "board.h"

struct zigbee_dev {
	struct serial_dev * serial;
};

/* ZTC-Mode Select Request */
uint8_t ztc_mod_sel_req[] = {
	0x02, 0xA3, 0x00, 0x0B, 0x01, 0x01, 0x01, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA9
};

/* Mac Association Permit */
uint8_t mac_init1[] = {
	0x02, 0x85, 0x09, 0x11, 0x41, 0x01, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xDD
};

/* Mac Beacon Payload Length */
uint8_t mac_init2[] = {
	0x02, 0x85, 0x09, 0x11, 0x46, 0x0F, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xD4
};

/* Mac Beacon Payload */
uint8_t mac_init3[] = {
	0x02, 0x85, 0x09, 0x11, 0x46, 0x00, 0x22, 0x84, 
	0xA1, 0x51, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x71
};

/* Mac Logical Channel */
uint8_t mac_init4[] = {
	0x02, 0x85, 0x09, 0x11, 0x21, 0x13, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xAF
};

/* Mac P0xAN, Id */
uint8_t mac_init5[] = {
	0x02, 0x85, 0x09, 0x11, 0x50, 0xA1, 0x51, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x3D
};

/* Mac Rx On When Idle */
uint8_t mac_init6[] = {
	0x02, 0x85, 0x09, 0x11, 0x52, 0x01, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xCE
};

/* Mac Short Address */
uint8_t mac_short_addr[] = {
	0x02, 0x85, 0x09, 0x11, 0x53, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xCE
};

/* Mac Start Request */
uint8_t mac_start_req[] = {
	0x02, 0x85, 0x0A, 0x09, 0xA1, 0x51, 0x13, 0x0F, 
	0x0F, 0x01, 0x00, 0x00, 0x00, 0x64
};

 /*  Mac Data Request (1st Payload) */
uint8_t mac_req_1st[] = {
	0x02, 0x87, 0x00, 0x35, 0xFF, 0xFF, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xA1, 0x51, 0x02, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA1, 
	0x51, 0x02, 0x1C, 0x55, 0x01, 0x09, 0x18, 0x26, 
	0x11, 0x00, 0x00, 0x01, 0x0F, 0xA7, 0x00, 0x00, 
	0x00, 0x01, 0x71, 0x1E, 0x00, 0x13, 0x00, 0x00, 
	0x00, 0x00, 0x71, 0x1E, 0x00, 0x07, 0x26, 0x11, 
	0x00, 0x57
};

/* 	Mac Data Request (Strobe ON) */
uint8_t mac_req_strb_on[] = {
	0x02, 0x87, 0x00, 0x3F, 0xFF, 0xFF, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xA1, 0x51, 0x02, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA1, 
	0x51, 0x02, 0x26, 0x55, 0x01, 0x48, 0x00, 0xFF, 
	0xFF, 0x00, 0x00, 0x1E, 0x0B, 0x08, 0x01, 0x01, 
	0x00, 0x21, 0xC0, 0x01, 0xF4, 0x02, 0x00, 0xFF, 
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 
	0x1E, 0x71, 0x00, 0x00, 0x00, 0x00, 0x13, 0xF2, 
	0x81, 0x00, 0x03, 0x85
};

/* 	Mac Data Request (Strobe OFF) */
uint8_t mac_req_strb_off[] = {
	0x02, 0x87, 0x00, 0x3F, 0xFF, 0xFF, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xA1, 0x51, 0x02, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xA1, 
	0x51, 0x02, 0x26, 0x55, 0x01, 0x48, 0x00, 0xFF, 
	0xFF, 0x00, 0x00, 0x1E, 0x0C, 0x08, 0x01, 0x01, 
	0x00, 0x21, 0xC0, 0x01, 0xF5, 0x02, 0x00, 0xFF, 
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 
	0x1E, 0x71, 0x00, 0x00, 0x00, 0x00, 0x13, 0xF2, 
	0x80, 0x01, 0x03, 0x83 
};

static bool zigbee_module_init(struct zigbee_dev * zigb)
{
	struct serial_dev * ser = zigb->serial;

	serial_send(ser, ztc_mod_sel_req, sizeof(ztc_mod_sel_req));
	thinkos_sleep(100);

	serial_send(ser, mac_init1, sizeof(mac_init1));
	thinkos_sleep(100);

	serial_send(ser, mac_init2, sizeof(mac_init2));
	thinkos_sleep(100);

	serial_send(ser, mac_init3, sizeof(mac_init3));
	thinkos_sleep(100);

	serial_send(ser, mac_init4, sizeof(mac_init4));
	thinkos_sleep(100);

	serial_send(ser, mac_init5, sizeof(mac_init5));
	thinkos_sleep(100);

	serial_send(ser, mac_init6, sizeof(mac_init6));
	thinkos_sleep(100);

	serial_send(ser, mac_short_addr, sizeof(mac_short_addr));
	thinkos_sleep(100);

	serial_send(ser, mac_start_req, sizeof(mac_start_req));
	thinkos_sleep(100);

	serial_send(ser, mac_req_1st, sizeof(mac_req_1st));
	thinkos_sleep(100);


	return true;
}

void __attribute__((noreturn)) zigbee_task(struct zigbee_dev * zigb)
{
	uint8_t buf[16];
	int n;
	int i;

	for (;;) {
		n = serial_recv(zigb->serial, buf, 16, 1000000);
		if (n > 0) {
			for (i = 0; i < n; ++i) {
				printf(" %02x", buf[i]);
			}
			printf("\r\n");
		}
	};
}

struct zigbee_dev * zigbee_init(void)
{
	static struct zigbee_dev zdev;
	static uint32_t zigb_stack[128];
	static const struct thinkos_thread_inf zigb_inf = {
		.stack_ptr = zigb_stack, 
		.stack_size = sizeof(zigb_stack), 
		.priority = 8,
		.thread_id = 32, 
		.paused = 0,
		.tag = "ZIGBEE"
	};

	/* USART2 TX */
	stm32_gpio_mode(IO_UART2_TX, ALT_FUNC, PUSH_PULL | SPEED_LOW);
	stm32_gpio_af(IO_UART2_TX, GPIO_AF7);
	/* USART2 RX */
	stm32_gpio_mode(IO_UART2_RX, ALT_FUNC, PULL_UP);
	stm32_gpio_af(IO_UART2_RX, GPIO_AF7);
	/* USART2 RTS */
	stm32_gpio_mode(IO_UART2_RTS, ALT_FUNC, PUSH_PULL | SPEED_LOW);
	stm32_gpio_af(IO_UART2_TX, GPIO_AF7);
	/* USART2 CTS */
	stm32_gpio_mode(IO_UART2_CTS, ALT_FUNC, PULL_UP);
	stm32_gpio_af(IO_UART2_RX, GPIO_AF7);

	zdev.serial = stm32f_uart2_serial_init(38400, SERIAL_8N1);

	thinkos_thread_create_inf((void *)zigbee_task, &zdev, &zigb_inf);

	zigbee_module_init(&zdev);

	return &zdev;
}

bool zigbee_nac_on(struct zigbee_dev * zigb)
{
	serial_send(zigb->serial, mac_req_strb_on, sizeof(mac_req_strb_on));
	return true;
}

bool zigbee_nac_off(struct zigbee_dev * zigb)
{
	serial_send(zigb->serial, mac_req_strb_off, sizeof(mac_req_strb_off));
	return true;
}

