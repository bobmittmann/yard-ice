<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="copyright" content="Copyright (c) Bob Mittmann 2014-2015"/>
<link rel="shortcut icon" href="/img/thinkos16x16.png"/>
<link rel="stylesheet" href="style.css" type="text/css" media="screen"/>

<title>CRAB Simulator Database</title>

<script src="/lib/zepto.js.gz"></script>
<script>	
	function alert(p, msg) {		
		var html = '<img style="float:none;vertical-align:middle"' +
			'src="/img/alert.png" alt="Alert! "/>&nbsp;' + msg;
		p.innerHTML = html;
	}
	
	function file_read(event) {
		$('.button').prop('disabled', true);
		$('#editor').text('');
		$.ajax({
			type: 'GET',
			url: 'file_read.cgi',
			data: { 
				fname: event.data.fname,
				port: $('#selport').val(),
			},
			dataType: 'text',
			timeout: 5000,
			context: $('body'),
			success: function(data) {
				$('#editor').text(data);
			},
			error: function(xhr, type){
				alert('Ajax error!')				
			},
			complete: function(xhr, status){
				$('.button').prop('disabled', false);
			}
		});
	}
	
	function file_upload(event) {
		var box = this.querySelector('#__msg');
		var port = $('#selport').val();
		alert(box, "Uploading file, please wait...");
		$('.button').prop('disabled', true);
		$('#editor').text('');
		$.ajax({
			url: this.action + '?port=' + port,
			type: 'POST',
			data: new FormData(this),
			processData: false,
			contentType: false,
			success: function(data) {				
				$('#editor').text(data);				
			},
			error: function(xhr, type){
				alert('Ajax error!')
			},
			complete: function(xhr, status){
				box.innerHTML = "";				
				$('.button').prop('disabled', false);
			}
		});
		event.preventDefault();
	}

	function db_getinfo() {
		var stat = $('#status');
		var port = $('#selport').val();
//		stat.html('');
		$('.button').prop('disabled', true);
		$.ajax({
			type: 'GET',
			url: 'db_getinfo.cgi',
			data: { 
				port: port
			},
			dataType: 'json',			
			timeout: 500,
			context: $('body'),
			success: function(data) {
				var html 
				try {
					if (data.hasOwnProperty('desc')) {	
						var desc = data.desc;
						if (desc == '')
							desc = '&lt;none&gt;'
						html = '<b>DB - ' + 
							data.version.major + '.' + 
							data.version.minor + '.' +
							data.version.build + '</b> -<i>' + 
							desc + '</i>';
					} else {
					    html = '<i>' + data.error + '</i>';						
					} 
				} catch(err) {
				    html = '<i>' + err.message + '</i>';
				}
				stat.html(html);				
			},
			error: function(xhr, type) { 
				alert('Ajax error!') 
			},
			complete: function(xhr, status){
				$('.button').prop('disabled', false);
			}

		});
	}

	function db_compile() {
		var stat = $('#status');
		var port = $('#selport').val();
		stat.html('');
		$('.button').prop('disabled', true);
		$('#results').text('');
		$.ajax({
			type: 'GET',
			url: 'db_compile.cgi',
			data: { 
				port: port
			},
			dataType: 'text',			
			timeout: 5000,
			context: $('body'),
			success: function(data) {
				$('#results').text(data);
			},
			error: function(xhr, type) { 
				alert('Ajax error!') 
			},
			complete: function(xhr, status){
				$('.button').prop('disabled', false);
				db_getinfo();
			}
		});
	}
	
	function file_write(event) {
		var port = $('#selport').val();
		var fname = event.data.fname;		
		$('.button').prop('disabled', true);
		$.ajax({
//			url: 'file_write.cgi?port=' + port + '&fname=' + fname,
			url: 'file_write.cgi',
			type: 'POST',
			data: $('#editor'),
//			async: false,
//			cache: false,
			timeout: 5000,
//			context: $('body'),
			processData: false,
			contentType: false,
//			contentType: 'application/x-www-form-urlencoded'			
//			contentType: 'multipart/form-data',
//			contentType: 'text/plain',
//			contentType: 'text/plain',
			success: function(data) {
			},
			error: function(xhr, type){
			},
			complete: function(xhr, status){
				$('.button').prop('disabled', false);
			}
		});
		event.preventDefault();
	}

	$( document ).ready(function() {
		$('#formdb').on('submit', file_upload);
        $('#btnread').on('click', { fname: 'db.js' }, file_read);
        $('#btncompile').on('click', db_compile);
        $('#selport').on('change', db_getinfo);
        db_getinfo();
    });

</script>
</head>

<body>
<h1>CRAB Simulator Database</h1>

<div class="form">
	<form id="formdb" enctype="multipart/form-data" action="db_load.cgi">
		<div>
		<table class="formgrid">
		<tr>
			<td style="text-align: right;">Status:</td>
			<td id="status"></td>
		</tr>
		<tr>
			<td style="text-align: right;">Simulator:</td>
			<td>
				<select id="selport">
					<option value="1">Port 1</option>
					<option value="2">Port 2</option>
					<option value="3">Port 3</option>
					<option value="4">Port 4</option>
					<option value="5">Port 5</option>
				</select>		
			</td>
		</tr>
		<tr>
			<td style="text-align: right;">Database:</td>
			<td>
			<input type="text" class="text" id="__fname"
				readonly="readonly" maxlength="128" size="20" /> <input
				type="button" class="button" value="Browse..."
				onclick="javascript: this.form.elements.namedItem('__browse').click()" />
			<input type="file" class="hidden" id="__browse" name="fname"
				onchange="javascript: this.form.elements.namedItem('__fname').value = this.value" />
			</td>
		</tr>
		<tr>
			<td></td>
			<td> 
			<input type="submit" class="button" value="Upload..." />
			</td>
		</tr>	
		</table>				
		</div>
		<div>
			<p id="__msg"></p>
		</div>		
	</form>
</div>

<div>
	<input id="btnread" type="button" class="button" value="Read..." />
	<input id="btncompile" type="button" class="button" value="Compile..." />
</div>

<div class="form" style="min-width: 10em; max-width: 40em;">
	<pre id="results" style="width: 100%; height: 6em;">
	</pre>		
	<textarea name="editor" id="editor" style="width: 100%; height: 20em;">
	</textarea> 
</div>

<hr>
<a href="https://github.com/bobmittmann/yard-ice"> <b>ThinkOS</b></a>
- Cortex-M Operating System - 
<i><a href="https://github.com/bobmittmann/yard-ice">YARD-ICE</a></i>
<br>&copy; Copyright 2013-2015, Bob Mittmann<br>

</body>
</html>

