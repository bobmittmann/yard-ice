<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="copyright" content="Copyright (c) Bob Mittmann 2014-2015"/>
<link rel="shortcut icon" href="/img/thinkos16x16.png"/>
<link rel="stylesheet" href="layout.css" type="text/css" media="screen"/>
<link rel="stylesheet" href="style.css" type="text/css" media="screen"/>

<title>CRAB Simulator Diagnostics</title>

<script src="zepto.min.js"></script>

<script>
	function row_create(tbody, i, name) {
		var row = tbody.insertRow(i);
		
		row.innerHTML = '<th style="text-align: right;">' + name + '</th>' + 
		'<td>0</td><td>0</td><td>0</td><td>0</td><td>0</td>'; 		
	}
	
	function table_create() {
		var table = $('#stats')[0];
		var tbody = table.getElementsByTagName('tbody')[0];
		var row = tbody.insertRow(0);
			
		row.innerHTML = '<th style="text-align: right;"">Simulator state</th>' + 
		'<td>Undef</td><td>Undef</td><td>Undef</td>' + 
		'<td>Undef</td><td>Undef</td>'; 

		row_create(tbody, 1, 'Uptime [seconds]');
		row_create(tbody, 2, 'General protocol error');
		row_create(tbody, 3, 'Clip poll received');
		row_create(tbody, 4, 'Clip parity error');
		row_create(tbody, 5, 'Clip poll responses');
		row_create(tbody, 6, 'Clip PW5 requests');
		row_create(tbody, 7, 'AP poll received');
		row_create(tbody, 8, 'AP header checksum error');
		row_create(tbody, 9, 'AP Null');
		row_create(tbody, 10, 'AP Read Alarm Latch Tens');
		row_create(tbody, 11, 'AP Read Trouble Latch Tens');
		row_create(tbody, 12, 'AP Read Presence');
		row_create(tbody, 13, 'AP Read Alarm Latch Units');
		row_create(tbody, 14, 'AP Read Trouble Latch Units');
		row_create(tbody, 15, 'AP Undefined message'); 		
		row_create(tbody, 16, 'SB Read Trouble Latch Tens');		
		row_create(tbody, 17, 'SB Read Presence');
		row_create(tbody, 18, 'SB Read Trouble Latch Units');
	}
	
	function port_error(port, status) {
		var tab = $('#stats')[0];
		var i = port;

		tab.rows[1].cells[i].innerHTML = status;		
		tab.rows[2].cells[i].innerHTML = 0; /* Uptime */
		tab.rows[3].cells[i].innerHTML = 0; /* General protocol error */
		tab.rows[4].cells[i].innerHTML = 0; /* Clip poll received */
		tab.rows[5].cells[i].innerHTML = 0; /* Clip parity error */
		tab.rows[6].cells[i].innerHTML = 0; /* Clip poll responses */
		tab.rows[7].cells[i].innerHTML = 0; /* CLip PW5 requests */
		tab.rows[8].cells[i].innerHTML = 0; /* AP mode poll received */
		tab.rows[9].cells[i].innerHTML = 0; /* AP mode header checksum error */
		tab.rows[10].cells[i].innerHTML = 0; /* AP Null */
		tab.rows[11].cells[i].innerHTML = 0; /* AP Read Alarm Latch Tens" */
		tab.rows[12].cells[i].innerHTML = 0; /* AP Read Trouble Latch Tens */
		tab.rows[13].cells[i].innerHTML = 0; /* AP Read Presence */
		tab.rows[14].cells[i].innerHTML = 0; /* AP Read Alarm Latch Units */
		tab.rows[15].cells[i].innerHTML = 0; /* AP Read Trouble Latch Units */
		tab.rows[16].cells[i].innerHTML = 0; 		
		tab.rows[17].cells[i].innerHTML = 0; /* AP Read Trouble Latch Tens Sounder Base */		
		tab.rows[18].cells[i].innerHTML = 0; /* AP Read Presence Sounder Base */
		tab.rows[19].cells[i].innerHTML = 0; /* AP Read Trouble Latch Units Sounder Base"*/
	}

	function port_update(port, data) {
		var tab = $('#stats')[0];
		var i = port;
		var s = data.stats;
		var uptime = data.uptime;
		var db_ok = data.db_ok;
		var cfg_ok = data.cfg_ok;
		
		if (db_ok) {
			if (db_ok) {
				tab.rows[1].cells[i].innerHTML = 'Online';
			} else {
				tab.rows[1].cells[i].innerHTML = 'Unconfig';				
			}			
		} else {
			tab.rows[1].cells[i].innerHTML = 'No Db';
		}
		
		tab.rows[2].cells[i].innerHTML = uptime;
		tab.rows[3].cells[i].innerHTML = s.proto_err; /* General protocol error */
		tab.rows[4].cells[i].innerHTML = s.clip_poll; /* Clip poll received */
		tab.rows[5].cells[i].innerHTML = s.clip_err;  /* Clip parity error */
		tab.rows[6].cells[i].innerHTML = s.clip_resp; /* Clip poll responses */
		tab.rows[7].cells[i].innerHTML = s.clip_pw5;  /* CLip PW5 requests */
		tab.rows[8].cells[i].innerHTML = s.ap_poll;   /* AP mode poll received */
		tab.rows[9].cells[i].innerHTML = s.ap_herr;   /* AP mode header checksum error */
		tab.rows[10].cells[i].innerHTML = s.ap_null;   /* AP Null */
		tab.rows[11].cells[i].innerHTML = s.ap_ralt;   /* AP Read Alarm Latch Tens" */
		tab.rows[12].cells[i].innerHTML = s.ap_rtlt;   /* AP Read Trouble Latch Tens */
		tab.rows[13].cells[i].innerHTML = s.ap_rp;     /* AP Read Presence */
		tab.rows[14].cells[i].innerHTML = s.ap_ralu;   /* AP Read Alarm Latch Units */
		tab.rows[15].cells[i].innerHTML = s.ap_rtlu;   /* AP Read Trouble Latch Units */
		tab.rows[16].cells[i].innerHTML = s.ap_uerr; 		
		tab.rows[17].cells[i].innerHTML = s.ap_rtltsb; /* AP Read Trouble Latch Tens Sounder Base */
		tab.rows[18].cells[i].innerHTML = s.ap_rpsb;   /* AP Read Presence Sounder Base */
		tab.rows[19].cells[i].innerHTML = s.ap_rtlusb; /* AP Read Trouble Latch Units Sounder Base"*/
	}

	function get_port_stats(port) {
		$.ajax({
			type: 'GET',
			url: 'sim_getstats.cgi',
			data: { 
				port: port
			},
			dataType: 'json',			
			timeout: 250,
			context: $('body'),
			success: function(data) {
				if (data.hasOwnProperty('error')) {
					port_error(port, 'Offline');
				} else {
					port_update(port, data);
				}		
			},
			error: function(xhr, type) {				
			}
		});
	}
	
	function poll_stats() {
		get_port_stats(1);
		get_port_stats(2);
		get_port_stats(3);
		get_port_stats(4);
		get_port_stats(5);
		setTimeout(poll_stats, 2000);
	}
	
	$(function() {
		table_create();
		poll_stats()
    });

</script>
</head>

<body>
<div class="wrapper">	
	<section>
		<table id="stats" class="zebra">
		 	<col width="250px" />
		    <col width="75px" />
		    <col width="75px" />
		    <col width="75px" />
		    <col width="75px" />
		    <col width="75px" />
			<thead>
				<tr>
					<th style="border-top-style: hidden; border-left-style: hidden; background: #fff"></th>
					<th>Port 1</th>
					<th>Port 2</th>
					<th>Port 3</th>
					<th>Port 4</th>
					<th>Port 5</th>
				</tr>
			</thead>
			<tbody>
			</tbody>	
		</table>
		
		*<b>AP</b>: Advanced Protocol.
		*<b>SB</b>: Sounder Base.
	</section>		
</div>

<header>
	<h1>CRAB Simulator Diagnostics</h1>		
</header>

<nav>
	<div class="top"></div>
	<div class="tabs"><ul>
		<li><a class="top" href="index.html">Home</a></li>
		<li><a href="network.html">Network</a></li>				
		<li><a href="sim_database.html">Database</a></li>
		<li><a href="sim_config.html">Config</a></li>
		<li><a href="sim_monitor.html">Monitor</a></li>
		<li><a href="sim_tools.html">Tools</a></li>
		<li><a class="active" href="#">Diagnostics</a></li>
		<li><a href="sim_script.html">Scripts</a></li>
		<li><a href="sim_test.html">Tests</a></li>
		<li><a href="sim_firmware.html">Firmware</a></li>	
		<li><a href="sim_debug.html">Debug</a></li>			
	</ul></div>
	<div class="bot"></div>
</nav>

<footer>
	<a href="https://https://github.com/bobmittmann/yard-ice">
	<img src="/img/thinkos47x20.png"></a> - Cortex-M Operating System -
	<i><a href="https://https://github.com/bobmittmann/yard-ice">YARD-ICE</a></i><br />
	&copy; Copyright 2013-2015, Bob Mittmann
</footer>

</body>
</html>

