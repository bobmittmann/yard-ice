<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="copyright" content="Copyright (c) Bob Mittmann 2014-2015"/>
<link rel="shortcut icon" href="/img/thinkos16x16.png"/>
<link rel="stylesheet" href="layout.css" type="text/css" media="screen"/>
<link rel="stylesheet" href="style.css" type="text/css" media="screen"/>

<title>CRAB Simulator Tools</title>

<script src="/lib/zepto.js.gz"></script>
<script>

	function get_stdout() {
		var port = $('#selport').val();
		$.ajax({
	 		type: 'GET',
			url: 'get_stdout.cgi',
			data: { 
				port: port,
	 		},
			dataType: 'text',
			timeout: 100,
			context: $('body'),
			success: function(data) {
				if (data) {
					var pre = $('#results');
   					pre.append(data);
   			    	pre.scrollTop(pre.prop("scrollHeight"));
   			    	stdout_flush_tmo = 500;
				}
	   			setTimeout(get_stdout, stdout_flush_tmo);
	   		},
			error: function(xhr, type){  
				setTimeout(get_stdout, 5000);
			},
			complete: function(xhr, status){				
			}
		});
	};

	function get_status(port) {
		var tr = $('#stat' + port);
		$.ajax({
			type: 'GET',
			url: 'get_status.cgi',
			data: { 
				port: port
			},
			dataType: 'json',			
			timeout: 250,
			context: $('body'),
			success: function(data) {
				var tr = $('#stat' + port);
				var html = '<td>' + port + '</td><td>' + data.state + '</td>';
				if (data.hasOwnProperty('kernel')) {
					html += '<td>ThinkOS-' + data.kernel.version.major + '.' + 
					data.kernel.version.minor + '.' +
					data.kernel.version.build + '</td>' +
					'<td>' + data.kernel.ticks + '</td>';
					if (data.hasOwnProperty('app')) {
						html += '<td>DevSim-' + data.app.version.major + '.' + 
						data.app.version.minor + '.' +
						data.app.version.build + '</td>' +
						'<td>' + data.app.uptime + '</td>';						
					} else {
						html += '<td>?.?.?</td><td>?</td>';
					}
				} else {
					html += '<td>?.?.?</td><td>?</td><td>?.?.?</td><td>?</td>';				
				}		
				tr.html(html);
			},
			error: function(xhr, type) { 
				alert('Ajax error!');
				if (port == $('#selport').val())
					stdout_flush_tmo = 5000;
			}
		});
	}
	
	function status_poll() {
	/*		setTimeout(status_poll, 5000); */
		get_status(1);
		get_status(2);
		get_status(3);
		get_status(4);
		get_status(5);
	}

	function alert_box(p, msg) {		
		var html = '<img style="float:none;vertical-align:middle"' +
			'src="/img/alert.png" alt="Alert! "/>&nbsp;' + msg;
		p.innerHTML = html;
	}

	function cmd_exec() {
		var port = $('#selport').val();
		var cmd = $('#cmd').val();
		$('.button').prop('disabled', true);
		$.ajax({
	 		type: 'GET',
			url: 'rpc_exec.cgi',
			data: { 
				port: port,
				cmd: cmd
	 		},
			dataType: 'text',
			timeout: 5000,
			context: $('body'),
			success: function(data) {
//	 			$('#results').empty();
//	   			$('#results').text(data);
	   		},
			error: function(xhr, type){ 
				alert('Ajax error!');
				stdout_flush_tmo = 5000;
			},
			complete: function(xhr, status){
				$('.button').prop('disabled', false);
			}
		});
	};

	function rpc_js() {		
		var port = $('#selport').val();
		var script = $('#script').val();
		$('.button').prop('disabled', true);
		$.ajax({
	 		type: 'POST',
			url: 'rpc_js.cgi?port=' + port,
	 		data: script,
			dataType: 'text',
			timeout: 5000,
			context: $('body'),
 			contentType: 'text/plain',
			success: function(data) {
	   			/* $('#results').text(data); */
	   		},
			error: function(xhr, type){ 
				alert('Ajax error!'); 
				stdout_flush_tmo = 5000;				
			},
			complete: function() {
				$('.button').prop('disabled', false);				
			}
		});
	};
	
	$(function() {
        $('#btnrefresh').on('click', status_poll);
		$('#formfirm').on('submit', firmware_upload);
		status_poll();
		$('#selport').on('change', get_stdout);
		get_stdout();
		stdout_flush_tmo = 500;
		$(document).on('click', '#btnexec', cmd_exec);
		$(document).on('click', '#btnjs', rpc_js);
	});
</script>

</head>

<body>
<div class="wrapper">

	<section>
		<div class="jsbox">
		<table class="thidden">
			<tr><th>Port 1:</th></tr>
			<tr style="height: 100%;"><td>
				<textarea class="script" id="script" autocomplete="off" wrap="logical" spellcheck="false" 
				style="width: 100%; height: 100%;">
var i;
		
for(i = 0; i &lt; 100; i = i + 1) {
&#09;printf("%d\n",i);
}
				</textarea>
			</td></tr>
			<tr style="height: auto;"><td>
				<button id="btnjs" class="button">Run Script...</button>
			</td></tr>
		</table>
		</div>		
		<div class="termbox">				
			<pre id="results" style="height: 100%;"></pre>
		</div>
	</section>
	
	<section>
		<div class="jsbox">
		<table class="thidden">
			<tr><th>Port 2:</th></tr>
			<tr style="height: 100%;"><td>
				<textarea class="script" id="script" autocomplete="off" wrap="logical" spellcheck="false"">
var i;
		
for(i = 0; i &lt; 100; i = i + 1) {
&#09;printf("%d\n",i);
}
				</textarea>
			</td></tr>
			<tr style="height: auto;"><td>
				<button id="btnjs" class="button">Run Script...</button>
			</td></tr>
		</table>
		</div>		
		<div class="termbox">				
			<pre id="results" style="height: 100%;"></pre>
		</div>
	</section>			
	
	<section>
		<div class="jsbox">
		<table class="thidden">
			<tr><th>Port 3:</th></tr>
			<tr style="height: 100%;"><td>
				<textarea class="script" id="script" autocomplete="off" wrap="logical" spellcheck="false"">
var i;
		
for(i = 0; i &lt; 100; i = i + 1) {
&#09;printf("%d\n",i);
}
				</textarea>
			</td></tr>
			<tr style="height: auto;"><td>
				<button id="btnjs" class="button">Run Script...</button>
			</td></tr>
		</table>
		</div>		
		<div class="termbox">				
			<pre id="results" style="height: 100%;"></pre>
		</div>
	</section>			
	
		<section>
		<div class="jsbox">
		<table class="thidden">
			<tr><th>Port 4:</th></tr>
			<tr style="height: 100%;"><td>
				<textarea class="script" id="script" autocomplete="off" wrap="logical" spellcheck="false">
var i;
		
for(i = 0; i &lt; 100; i = i + 1) {
&#09;printf("%d\n",i);
}
				</textarea>
			</td></tr>
			<tr style="height: auto;"><td>
				<button id="btnjs" class="button">Run Script...</button>
			</td></tr>
		</table>
		</div>		
		<div class="termbox">				
			<pre class="stdout" id="results" style="height: 100%;"></pre>
		</div>
	</section>			
	
		<section>
		<div class="jsbox">
		<table class="thidden">
			<tr><th>Port 5:</th></tr>
			<tr style="height: 100%;"><td>
				<textarea class="script" id="script" autocomplete="off" wrap="logical" spellcheck="false">
var i;
		
for(i = 0; i &lt; 100; i = i + 1) {
&#09;printf("%d\n",i);
}
				</textarea>
			</td></tr>
			<tr style="height: auto;"><td>
				<button id="btnjs" class="button">Run Script...</button>
			</td></tr>
		</table>
		</div>		
		<div class="termbox">				
			<pre id="results" style="height: 100%;"></pre>
		</div>
	</section>			
				
</div>
	
<header>
	<h1>CRAB Simulator Tools</h1>
</header>

<nav>
	<div class="top"></div>
	<div class="tabs"><ul>
		<li><a class="top" href="index.html">Home</a></li>
		<li><a href="network.html">Network</a></li>				
		<li><a href="sim_database.html">Database</a></li>
		<li><a href="sim_config.html">Config</a></li>
		<li><a href="sim_monitor.html">Monitor</a></li>
		<li><a href="sim_tools.html">Tools</a></li>
		<li><a href="sim_diag.html">Diagnostics</a></li>
		<li><a class="active" href="#">Scripts</a></li>
		<li><a href="sim_test.html">Tests</a></li>
		<li><a href="sim_firmware.html">Firmware</a></li>	
		<li><a href="sim_debug.html">Debug</a></li>		
	</ul>
	</div><div class="bot"></div>
</nav>

<footer>
	<a href="https://https://github.com/bobmittmann/yard-ice">
	<img src="/img/thinkos47x20.png"></a> - Cortex-M Operating System -
	<i><a href="https://https://github.com/bobmittmann/yard-ice">YARD-ICE</a></i><br />
	&copy; Copyright 2013-2015, Bob Mittmann
</footer>	
