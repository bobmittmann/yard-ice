<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="copyright" content="Copyright (c) Bob Mittmann 2014-2015"/>
<link rel="shortcut icon" href="/img/thinkos16x16.png"/>
<link rel="stylesheet" href="style.css" type="text/css" media="screen"/>

<title>CRAB Device Monitor</title>

<script src="/lib/zepto.js.gz"></script>
<script>
	function get_opt() {
		var port = $('#selport').val();
		var dev_type = $('#seltype').val();
		
		$.ajax({
			type: 'GET',
			url: 'sim_getattr.cgi',
			data: { 
				port: port,
				dev_type: dev_type,
				attr_offs: 0,
				base_addr: 0,
				count: 100
			},
			dataType: 'json',			
			timeout: 500,
			context: $('body'),
			success: function(data) {				
				var rows = $('tr', $('#optlst'));				 
				if (data.hasOwnProperty('attr')) {
					var lst = data.attr;
					for (i = 0; i < lst.length; ++i) {
						var tr = rows.eq(i);
						var val = lst[i];
						var addr = val & 0xff;
						var model = (val >> 8) & 0x3f;
						var apen = (val >> 14) & 1;
						var mod = (val >> 15) & 1;
						var en = (val >> 16) & 1;
						var cfg = (val >> 17) & 1;
						var led = (val >> 18) & 1;
						var tst = (val >> 19) & 1;
						var out1 = (val >> 20) & 1;
						var out2 = (val >> 21) & 1;
						var out3 = (val >> 22) & 1;
						var out5 = (val >> 23) & 1;
						var alm = (val >> 24) & 0xf;
						var tbl = (val >> 28) & 0xf;
						
						var html = 	'<td>' + addr + '</td>' + 
							'<td>' + model + '</td>' +
							'<td>' + (apen ? 'AP' : 'Clip') + '</td>' +
							'<td>' + (cfg ? (en ? 'Enabled' : 'Disabled' ) : 'Unconfig') + '</td>' +
							'<td>' + (led ? 'On' : 'Off') + '</td>' +
							'<td>' + (tst ? 'Yes' : 'No') + '</td>' +
							'<td>' + out5 + ' ' + out3 + ' ' + out2 + ' ' + out1 + '</td>' +
							'<td>' + alm + '</td>' +
							'<td>' + tbl + '</td>';
						tr.html(html);
					}
				}		
			},
			error: function(xhr, type) { 
				alert('Ajax error!') 
			},
			complete: function(xhr, status){				
			}
		});
	}
	
	function create_table() {
		for (i = 0; i < 100; ++i) {
			$('#optlst').append('<tr>' +
				'<td>' + i + '</td>' + 
				'<td>Unk</td>' +
				'<td>Clip</td>' +
				'<td>Unk</td>' +
				'<td>Off</td>' +
				'<td>No</td>' +
				'<td>0 0 0 0</td>' +
				'<td>0</td>' +
				'<td>0</td>' +
				'</tr>'
			);
		}
	}

	$(function() {
        create_table();
        $('#btnrefresh').on('click', get_opt);
		get_opt();
    });
</script>
</head>

<body>

<div id="header">
	<h1>CRAB Simulator Monitor</h1>
</div>

<div id="navigation">
	<ul>
		<li><a href="index.html">Home</a></li>
		<li><a href="sim_database.html">Database</a></li>
		<li><a href="sim_config.html">Config</a></li>
		<li><a href="#" class="active">Monitor</a></li>
		<li><a href="sim_tools.html">Tools</a></li>
		<li><a href="sim_diag.html">Diagnostics</a></li>
	</ul>
</div>

<div id="content">


<div class="form">
	<table class="formgrid">
	<tr>
		<td style="text-align: right;">Simulator:</td>
		<td>
			<select id="selport">
				<option value="1">Port 1</option>
				<option value="2">Port 2</option>
				<option value="3">Port 3</option>
				<option value="4">Port 4</option>
				<option value="5">Port 5</option>
			</select>		
		</td>
	</tr>
	<tr>
		<td style="text-align: right;">Device type:</td>
		<td>
			<select id="seltype">
				<option value="0">Sensor</option>
				<option value="1">Module</option>
				<option value="2">Base</option>
			</select>		
		</td>	
		<td></td>
		<td>
		<input id="btnrefresh" type="button" class="button" value="Refresh..." /> 
		</td>
	</tr>	
	</table>				
</div>

<table class="monitor">
	<thead>
		<tr>
			<th>Addr</th>
			<th>Model</th>
			<th>AP</th>
			<th>State</th>		
			<th>LED</th>
			<th>Test</th>
			<th>Outputs</th>
			<th>Alarm</th>
			<th>Trouble</th>		
		</tr>
	</thead>
	<tbody id="optlst">
	</tbody>
</table>

</div>

<div id="footer">
<a href="https://https://github.com/bobmittmann/yard-ice"><img src="/img/thinkos47x20.png"></a> - Cortex-M Operating System - 
<i><a href="https://https://github.com/bobmittmann/yard-ice">YARD-ICE</a></i><br>
&copy; Copyright 2013-2015, Bob Mittmann<br>
</div>

</body>
</html>
