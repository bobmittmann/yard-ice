<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="copyright" content="Copyright (c) Bob Mittmann 2014-2015"/>
<link rel="shortcut icon" href="/img/thinkos16x16.png"/>
<link rel="stylesheet" href="layout.css" type="text/css" media="screen"/>
<link rel="stylesheet" href="style.css" type="text/css" media="screen"/>

<title>CRAB Simulator Configuration</title>

<script src="zepto.min.js"></script>
<script src="simlib.js"></script>

<script>
	function get_stdout() {
		var port = $('#selport').val();
		var pre = $('#results');
		simlib_stdout_flush(port, pre);
	};
	
	function file_read(event) {
		var port = $('#selport').val();
		var editor = $('#editor');
		var fname = 'cfg.js';
		
		editor.text('');		
		simlib_edit_file_read(port, fname, editor);
	}
	
	function file_write(event) {
		var port = $('#selport').val();
		var editor = $('#editor');
		var fname = 'cfg.js';
		
		simlib_edit_file_write(port, fname, editor);
	}
	
	function file_upload(event) {
		var form = this;
		var msg_box = form.querySelector('#__msg');
		var port = $('#selport').val();
		var editor = $('#editor');

		editor.text('');
		simlib_edit_file_upload(port, editor, form, msg_box);
	}
	
	function cfg_getinfo() {
		var stat = $('#status');
		var port = $('#selport').val();
		
		stat.html('');
		$('.button').prop('disabled', true);
		$.ajax({
			type: 'GET',
			url: 'cfg_getinfo.cgi',
			data: { 
				port: port
			},
			dataType: 'json',			
			timeout: 500,
			context: $('body'),
			success: function(data) {
				var html 
				try {
					if (data.hasOwnProperty('tag')) {	
						var tag = data.tag;
						if (tag == '')
							tag = '&lt;notag&gt;'
						html = '<b>' + tag + '-' + 
							data.version.major + '.' + 
							data.version.minor + '.' +
							data.version.build + '</b> -<i>' + 
							data.desc + '</i>';
					} else {
					    html = '<i>' + data.error + '</i>';						
					} 
				} catch(err) {
				    html = '<i>' + err.message + '</i>';
				}
				stat.html(html);				
			},
			error: function(xhr, type) { 
				$('#results').append('Ajax error: ' + type + '\n');
			},
			complete: function(xhr, status) {
				$('.button').prop('disabled', false);
			}

		});
	}
	
	function cfg_compile() {
		var stat = $('#status');
		var port = $('#selport').val();
		var box = $('#__msg')[0];

		stat.html('');
		$('.button').prop('disabled', true);
		alert_show(box, "Compiling configuration, please wait...");
		
		$.ajax({
			type: 'GET',
			url: 'cfg_compile.cgi',
			data: { 
				port: port
			},
			dataType: 'text',			
			timeout: 5500,
			context: $('body'),
			success: function(data) {
				$('#results').text(data);				
			},
			error: function(xhr, type) {
				$('#results').append('Ajax error: ' + type + '\n');
			},
			complete: function(xhr, status){
				alert_hide(box);
				$('.button').prop('disabled', false);
				cfg_getinfo();
			}
		});
	}
	
	$(function() {
		$('#formcfg').on('submit', file_upload);
        $('#btnread').on('click', file_read);
        $('#btnwrite').on('click', file_write);
        $('#btncompile').on('click', cfg_compile);
        $('#selport').on('change', cfg_getinfo);
        cfg_getinfo();
    });

</script>
</head>

<body>

<div class="wrapper">		
	<section>
	<form id="formcfg" enctype="multipart/form-data" action="cfg_load.cgi">
		<div>
		<table class="formgrid">
		<tr>
			<th>Status:</th>
			<td id="status"></td>
		</tr>
		<tr>
			<th>Simulator:</th>
			<td>
				<select id="selport">
					<option value="1">Port 1</option>
					<option value="2">Port 2</option>
					<option value="3">Port 3</option>
					<option value="4">Port 4</option>
					<option value="5">Port 5</option>
				</select>		
			</td>
		</tr>
		<tr>
			<th>Configuration:</th>
			<td>
			<input type="text" class="text" id="__fname"
				readonly="readonly" maxlength="128" size="20" /> <input
				type="button" class="button" value="Browse..."
				onclick="javascript: this.form.elements.namedItem('__browse').click()" />
			<input type="file" class="hidden" id="__browse" name="fname"
				onchange="javascript: this.form.elements.namedItem('__fname').value = this.value" />
			</td>
		</tr>
		<tr>
			<td></td>
			<td> 
			<input type="submit" class="button" value="Upload..." />
			</td>
		</tr>	
		</table>				
		</div>
		<div>
			<p id="__msg"></p>
		</div>		
	</form>
	</section>

	<section>
		<input id="btnread" type="button" class="button" value="Read..." />
		<input id="btnwrite" type="button" class="button" value="Write..." />		
		<input id="btncompile" type="button" class="button" value="Compile..." />
	</section>
	
	<section>
		<pre id="results" style="width: 100%; height: 10em;">
		</pre>		
		<textarea name="editor" id="editor" style="width: 100%; height: 20em;">
		</textarea> 
	</section>
</div>

<header>
	<h1>CRAB Simulator Configuration</h1>		
</header>

<nav>
	<div class="top" ></div>
	<div class="tabs"><ul>
		<li><a class="top" href="index.html">Home</a></li>
		<li><a href="network.html">Network</a></li>		
		<li><a href="sim_database.html">Database</a></li>		
		<li><a class="active" href="#">Config</a></li>
		<li><a href="sim_monitor.html">Monitor</a></li>
		<li><a href="sim_tools.html">Tools</a></li>
		<li><a href="sim_diag.html">Diagnostics</a></li>
		<li><a href="sim_script.html">Scripts</a></li>
		<li><a href="sim_test.html">Tests</a></li>
		<li><a href="sim_firmware.html">Firmware</a></li>				
	</ul></div>
	<div class="bot"></div>
</nav>

<footer>
	<a href="https://https://github.com/bobmittmann/yard-ice">
	<img src="/img/thinkos47x20.png"></a> - Cortex-M Operating System -
	<i><a href="https://https://github.com/bobmittmann/yard-ice">YARD-ICE</a></i><br />
	&copy; Copyright 2013-2015, Bob Mittmann
</footer>

</body>
</html>
