<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="copyright" content="Copyright (c) Bob Mittmann 2014-2015"/>
<link rel="shortcut icon" href="/img/thinkos16x16.png"/>
<link rel="stylesheet" href="style.css" type="text/css" media="screen"/>

<title>CRAB Device Simulator - Tools</title>

<script src="/lib/zepto.js.gz"></script>
<script>
	function get_status(port) {
		var tr = $('#stat' + port);
		$.ajax({
			type: 'GET',
			url: 'get_status.cgi',
			data: { 
				port: port
			},
			dataType: 'json',			
			timeout: 250,
			context: $('body'),
			success: function(data) {
				var tr = $('#stat' + port);
				var html = '<td>' + port + '</td><td>' + data.state + '</td>';
				if (data.hasOwnProperty('kernel')) {
					html += '<td>ThinkOS-' + data.kernel.version.major + '.' + 
					data.kernel.version.minor + '.' +
					data.kernel.version.build + '</td>' +
					'<td>' + data.kernel.ticks + '</td>';
					if (data.hasOwnProperty('app')) {
						html += '<td>DevSim-' + data.app.version.major + '.' + 
						data.app.version.minor + '.' +
						data.app.version.build + '</td>' +
						'<td>' + data.app.uptime + '</td>';						
					} else {
						html += '<td>?.?.?</td><td>?</td>';
					}
				} else {
					html += '<td>?.?.?</td><td>?</td><td>?.?.?</td><td>?</td>';				
				}		
				tr.html(html);
			},
			error: function(xhr, type) { 
				alert('Ajax error!') 
			}
		});
	}
	
	function status_poll() {
	/*		setTimeout(status_poll, 5000); */
		get_status(1);
		get_status(2);
		get_status(3);
		get_status(4);
		get_status(5);
	}

	function alert_box(p, msg) {		
		var html = '<img style="float:none;vertical-align:middle"' +
			'src="/img/alert.png" alt="Alert! "/>&nbsp;' + msg;
		p.innerHTML = html;
	}

	$(function() {
        $('#btnrefresh').on('click', status_poll);
		$('#formfirm').on('submit', firmware_upload);		
		status_poll();
    });

</script>
</head>

<body>
<h1>CRAB Device Simulator - Tools</h1>

<table>
	<thead>
		<tr>
		<th>Port</th>
		<th>Status</th>
		<th>Kernel</th>
		<th>Ticks</th>		
		<th>Firmware</th>
		<th>Uptime</th>
		</tr>
	</thead>
	<tr id="stat1">
		<td>1</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>		
	</tr>
	<tr id="stat2">
		<td>2</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>		
	</tr>	
	<tr id="stat3">
		<td>3</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>		
	</tr>	
	<tr id="stat4">
		<td>4</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>		
	</tr>	
	<tr id="stat5">
		<td>5</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>
		<td>...</td>				
	</tr>		
</table>

<input id="btnrefresh" type="button" class="button" value="Refresh..." />

<hr />

<h2>Firmware upgrade</h2>

<div class="form">
	<form id="formfirm" enctype="multipart/form-data" action="firmware_load.cgi">
		<div>
		<table class="formgrid">
		<tr>
			<td style="text-align: right;">Simulator:</td>
			<td>
				<select id="selport">
					<option value="1">Port 1</option>
					<option value="2">Port 2</option>
					<option value="3">Port 3</option>
					<option value="4">Port 4</option>
					<option value="5">Port 5</option>
				</select>		
			</td>
		</tr>
		<tr>
			<td style="text-align: right;">Firmware:</td>
			<td>
			<input type="text" class="text" id="__fname"
				readonly="readonly" maxlength="128" size="20" /> <input
				type="button" class="button" value="Browse..."
				onclick="javascript: this.form.elements.namedItem('__browse').click()" />
			<input type="file" class="hidden" id="__browse" name="fname"
				onchange="javascript: this.form.elements.namedItem('__fname').value = this.value" />
			</td>
		</tr>
		<tr>
			<td></td>
			<td> 
			<input type="submit" class="button" value="Upload..." />
			</td>
		</tr>	
		</table>				
		</div>
		<div>
			<p id="__msg"></p>
		</div>		
	</form>
</div>

<script>
	function firmware_upload(event) {
		var lst = this.elements;
		var box = this.querySelector('#__msg');	
		var port = $('#selport').val();
		
		alert_box(box, "Uploading firmware, please wait...");
		$('.button').prop('disabled', true);
		$.ajax({
			url: this.action + '?port=' + port,
			type: 'POST',
			data: new FormData(this),
			processData: false,
			contentType: false,
			success: function() {
				box.innerHTML = "";
			    setTimeout(function(){ 
			    	get_status(port);
			    }, 500);  
			},
			error: function(xhr, type){
				alert('Ajax error!')
			},
			complete: function(xhr, status){
				box.innerHTML = "";
				$('.button').prop('disabled', false);
			}
		});
		event.preventDefault();
	}
</script>

<hr />

<div class="form" style="min-width: 10em; max-width: 40em;">
	<table class="formgrid" style="width: 100%; table-layout: fixed;">
	<tr>
		<td colspan="2">
		<pre id="results" style="height: 10em;"></pre>		
		</td>
	</tr>
	<tr>		
		<td>
		<input type="text" id="cmd" value="help" list="browsers" 
		style="width: 100%; font-family: monospace;"/>
		<datalist id="browsers">
			<option value="ls">
			<option value="rm cfg.bin">
			<option value="rm db.bin">
		</datalist>
		</td>
		<td style="vertical-align: top;">		
		<button id="btnexec" class="button">Exec...</button>
		</td>
	</tr>
	<tr>
		<td>	
<textarea id="script" style="width: 100%; height: 8em;">
var i;
		
for(i = 0; i &lt; 100; i = i + 1) {
&#09;printf("%d\n",i);
}
</textarea>
		</td>
		<td style="vertical-align: top;">						
		<button id="btnjs" class="button">Run Script...</button>
		</td>
	</tr>
	</table>
</div>
<script>
	function cmd_exec() {
		var port = $('#selport').val();
		var cmd = $('#cmd').val();
		$('.button').prop('disabled', true);
		$.ajax({
	 		type: 'GET',
			url: 'rpc_exec.cgi',
			data: { 
				port: port,
				cmd: cmd
	 		},
			dataType: 'text',
			timeout: 5000,
			context: $('body'),
			success: function(data) {
	 			$('#results').empty();
	   			$('#results').text(data);
	   		},
			error: function(xhr, type){ 
				alert('Ajax error!') 
			},
			complete: function(xhr, status){
				$('.button').prop('disabled', false);
			}
		});
	};

	function rpc_js() {		
		var port = $('#selport').val();
		var script = $('#script').val();
		$('.button').prop('disabled', true);
		$.ajax({
	 		type: 'GET',
			url: 'rpc_js.cgi',
			data: {
				port: port,
				script: script
	 		},
			dataType: 'text',
			timeout: 5000,
			context: $('body'),
/*			contentType: 'multipart/form-data', */
			success: function(data) {
	 			$('#results').empty();
	   			$('#results').text(data);
	   		},
			error: function(xhr, type){ 
				alert('Ajax error!') 
			},
			complete: function() {
				$('.button').prop('disabled', false);				
			}
		});
	};
	
	$(function() {
		$(document).on('click', '#btnexec', cmd_exec);
		$(document).on('click', '#btnjs', rpc_js);
	});
</script>

<hr>
<a href="https://github.com/bobmittmann/yard-ice"> <b>ThinkOS</b></a>
- Cortex-M Operating System - 
<i><a href="https://github.com/bobmittmann/yard-ice">YARD-ICE</a></i>
<br>&copy; Copyright 2013-2015, Bob Mittmann<br>

</body>
</html>

