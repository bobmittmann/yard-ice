<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="copyright" content="Copyright (c) Bob Mittmann 2014-2015"/>
<link rel="shortcut icon" href="/img/thinkos16x16.png"/>
<link rel="stylesheet" href="layout.css" type="text/css" media="screen"/>
<link rel="stylesheet" href="style.css" type="text/css" media="screen"/>

<title>CRAB Simulator - RPC Test</title>

<script src="zepto.min.js"></script>
<script src="simlib.js"></script>

<script>
	function get_stdout() {
		var port = $('#selport').val();
		var pre = $('#results');
		simlib_stdout_flush(port, pre);
	};
	
	function get_status(port) {
		var tr = $('#stat' + port)[0];
		simlib_status_get(port, tr);
	}
	
	function status_poll() {
		setTimeout(status_poll, 5000);
		get_status(1);
		get_status(2);
		get_status(3);
		get_status(4);
		get_status(5);
	}

	function rpc_test(event) {
		$('#results').empty();
		$.ajax({
			type: 'GET',
			url: 'rpc_test.cgi',
			data: { 
				code: event.data.code,
				port: $('#selport').val(),
				addr: $('#addr').val(),
				size: $('#size').val(),
				fname: $('#fname').val()
			},
			dataType: 'text',
			timeout: 5000,
			context: $('body'),
			success: function(data) {
				$('#results').text(data);
			},
			error: function(xhr, type){
				$('#results').text('Ajax error!\n');
			}
		});
	}

	function file_upload(event) {
		var lst = this.elements;
		var box = this.querySelector('#__msg');		
		alert_show(box, "Uploading file, please wait...");		
		$.ajax({
			url: this.action + '?port=' + $('#selport').val(),
			type: 'POST',
			data: new FormData(this),
			processData: false,
			contentType: false,
			success: function() {
				alert_hide(box);
			},
			error: function(xhr, type){
				alert_show(box, "ERROR!");
			}
		});
		event.preventDefault();
	}

	function firmware_upload(event) {
		var lst = this.elements;
		var box = this.querySelector('#__msg');		
		
		alert_show(box, "Uploading firmware, please wait...");		
		$.ajax({
			url: this.action + '?port=' + $('#selport').val(),
			type: 'POST',
			data: new FormData(this),
			processData: false,
			contentType: false,
			success: function() {
				alert_hide(box);
			},
			error: function(xhr, type){
				alert_show(box, "ERROR!");
			}
		});
		event.preventDefault();
	}

	$(function() {
        $('#btnrefresh').on('click', status_poll);
        $('#btn1').on('click', { code: 1 }, rpc_test);
        $('#btn2').on('click', { code: 2 }, rpc_test);
        $('#btn3').on('click', { code: 3 }, rpc_test);
        $('#btn4').on('click', { code: 4 }, rpc_test);
        $('#btn5').on('click', { code: 5 }, rpc_test);
        $('#btn6').on('click', { code: 6 }, rpc_test);
        $('#btn7').on('click', { code: 7 }, rpc_test);
        $('#btn8').on('click', { code: 8 }, rpc_test);
        $('#btn9').on('click', { code: 9 }, rpc_test);
        $('#btn10').on('click', { code: 10 }, rpc_test);
        $('#btn11').on('click', { code: 11 }, rpc_test);

		$('#formdb').on('submit', file_upload);
		$('#formcfg').on('submit', file_upload);
		$('#formfirm').on('submit', firmware_upload);
		
		status_poll();
    });
</script>
</head>

<body>

<div class="wrapper">
	<section>
		<h2>Port Status</h2>
		<table class="zebra">
			<thead>
				<tr>
				<th>Port</th>
				<th>Status</th>
				<th>Kernel</th>
				<th>Ticks</th>		
				<th>Firmware</th>
				<th>Uptime</th>
				</tr>
			</thead>
			<tr id="stat1">
				<td>1</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>		
			</tr>
			<tr id="stat2">
				<td>2</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>		
			</tr>	
			<tr id="stat3">
				<td>3</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>		
			</tr>	
			<tr id="stat4">
				<td>4</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>		
			</tr>	
			<tr id="stat5">
				<td>5</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>
				<td>...</td>				
			</tr>		
		</table>

		<input id="btnrefresh" type="button" class="button" value="Refresh..." />
	</section>
	
	<section>
		<h2>RPC Tests</h2>
		<table class="formgrid">
			<tr>
				<td style="text-align: right;">Simulator:</td>
				<td>
					<select id="selport">
						<option value="1">Port 1</option>
						<option value="2">Port 2</option>
						<option value="3">Port 3</option>
						<option value="4">Port 4</option>
						<option value="5">Port 5</option>
					</select>		
				</td>
				<td>
				</td>
				<td>
					<input id="btn2" type="button" value="Suspend" />
				</td>		
				<td>
					<input id="btn3" type="button" value="Resume" />
				</td>
				<td>
					<input id="btn10" type="button" value="Exec" />
				</td>
				<td>
					<input id="btn1" type="button" value="Reset" />
				</td>		
				<td>
					<input id="btn11" type="button" value="Safe" />
				</td>		
						
			</tr>
			<tr>
				<td style="text-align: right;">File:</td>
				<td>
					<input id="fname" type="text" maxlength="100" size="10" value="cfg.js" />
				</td>
				<td>
				</td>		
				<td>
				</td>		
				<td>
					<input id="btn4" type="button" value="File Write" />		
				</td>
				<td>
					<input id="btn5" type="button" value="File Read" />
				</td>
				<td>
					<input id="btn6" type="button" value="File Erase" />
				</td>		
			</tr>
			<tr>
				<td style="text-align: right;">Address:</td>
				<td>
					<input id="addr" type="text" maxlength="10" size="10" value="0x08010000" />
				</td>
				<td style="text-align: right;">Size:</td>
				<td>
					<input id="size" type="number" maxlength="4" size="3" min="1" max="8192" value="256" />
				</td>		
				<td>
					<input id="btn7" type="button" value="Mem read" />	
				</td>
				<td>
					<input id="btn8" type="button" value="Mem erase" />
				</td>
				<td>
					<input id="btn9" type="button" value="Mem CRC" />
				</td>		
			</tr>	
		</table>
		
		<div class="termbox">							
			<pre id="results" style="height: 100%;"></pre>
		</div>		
	</section>

	<section>		
		<h2>Database upload</h2>
		<div class="form">
			<form id="formdb" enctype="multipart/form-data" action="db_load.cgi">
				<div class="fbody">
					File: <input type="text" class="text" id="__fname"
						readonly="readonly" maxlength="128" size="20" /> <input
						type="button" class="button" value="Browse..."
						onclick="javascript: this.form.elements.namedItem('__browse').click()" />
					<input type="file" class="hidden" id="__browse" name="fname"
						onchange="javascript: this.form.elements.namedItem('__fname').value = this.value" />
				</div>
				<div class="ffoot">
					<input type="reset" class="button" value="Reset" /> <input
						type="submit" class="button" value="Upload..." />
				</div>
				<div>
					<p id="__msg"></p>
				</div>		
			</form>
		</div>
	</section>

	<section>		
		<h2>Config upload</h2>
		<div class="form">
			<form id="formcfg" enctype="multipart/form-data" action="cfg_load.cgi">
				<div class="fbody">
					File: <input type="text" class="text" id="__fname"
						readonly="readonly" maxlength="128" size="20" /> <input
						type="button" class="button" value="Browse..."
						onclick="javascript: this.form.elements.namedItem('__browse').click()" />
					<input type="file" class="hidden" id="__browse" name="fname"
						onchange="javascript: this.form.elements.namedItem('__fname').value = this.value" />
				</div>
				<div class="ffoot">
					<input type="reset" class="button" value="Reset" /> <input
						type="submit" class="button" value="Upload..." />
				</div>
				<div>
					<p id="__msg"></p>
				</div>
			</form>
		</div>
	</section>

	<section>				
		<h2>Firmware upgrade</h2>
		<div class="form">
			<form id="formfirm" enctype="multipart/form-data" action="firmware_load.cgi">
				<div class="fbody">
					File: <input type="text" class="text" id="__fname"
						readonly="readonly" maxlength="128" size="20" /> <input
						type="button" class="button" value="Browse..."
						onclick="javascript: this.form.elements.namedItem('__browse').click()" />
					<input type="file" class="hidden" id="__browse" name="fname"
						onchange="javascript: this.form.elements.namedItem('__fname').value = this.value" />
				</div>
				<div class="ffoot">
					<input type="reset" class="button" value="Reset" /> <input
						type="submit" class="button" value="Upload..." />
				</div>
				<div>
					<p id="__msg"></p>
				</div>
			</form>
		</div>
	</section>

</div>
	
<header>
	<h1>CRAB Simulator - RPC Test</h1>
</header>


<nav>
	<div class="top"></div>
	<div class="tabs"><ul>
		<li><a class="top" href="index.html">Home</a></li>
		<li><a href="network.html">Network</a></li>				
		<li><a href="sim_database.html">Database</a></li>
		<li><a href="sim_config.html">Config</a></li>
		<li><a href="sim_monitor.html">Monitor</a></li>
		<li><a href="sim_tools.html">Tools</a></li>
		<li><a href="sim_diag.html">Diagnostics</a></li>
		<li><a href="sim_script.html">Scripts</a></li>
		<li><a class="active" href="#">Tests</a></li>
		<li><a href="sim_firmware.html">Firmware</a></li>			
	</ul>
	</div><div class="bot"></div>
</nav>

<footer>
	<a href="https://https://github.com/bobmittmann/yard-ice">
	<img src="/img/thinkos47x20.png"></a> - Cortex-M Operating System -
	<i><a href="https://https://github.com/bobmittmann/yard-ice">YARD-ICE</a></i><br />
	&copy; Copyright 2013-2015, Bob Mittmann
</footer>	

